<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --danger: #f72585;
            --dark: #212529;
            --light: #f8f9fa;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* LED Background Effect */
        .led-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.15;
            pointer-events: none;
        }

        .led-strip {
            position: absolute;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff00, #00ff80, #00ffff, #0080ff, 
                #0000ff, #8000ff, #ff00ff, #ff0080);
            background-size: 1200% 100%;
            animation: led-animation 8s linear infinite;
            filter: blur(1px);
        }

        .led-strip:nth-child(2) {
            top: 20%;
            animation-delay: -1s;
        }

        .led-strip:nth-child(3) {
            top: 40%;
            animation-delay: -2s;
        }

        .led-strip:nth-child(4) {
            top: 60%;
            animation-delay: -3s;
        }

        .led-strip:nth-child(5) {
            top: 80%;
            animation-delay: -4s;
        }

        @keyframes led-animation {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 100% 0%;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff00, #00ff80, #00ffff, #0080ff, 
                #0000ff, #8000ff, #ff00ff, #ff0080);
            background-size: 1200% 100%;
            animation: led-animation 8s linear infinite;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--gray);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger);
        }

        .status-indicator.connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.5s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        h2 {
            font-size: 1.5rem;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .toggle-label {
            font-size: 1.1rem;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray);
            transition: var(--transition);
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        /* Custom Dropdown Styling */
        .dropdown-container {
            position: relative;
            margin-top: 15px;
            margin-bottom: 20px; 
        }

        .dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dropdown-header:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .dropdown-header.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-color: var(--primary);
        }

        .dropdown-arrow {
            transition: var(--transition);
        }

        .dropdown-header.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-list {
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            z-index: 10; 
            backdrop-filter: blur(10px);
            margin-top: -1px; 
        }

        .dropdown-list.show {
            max-height: 250px;
            overflow-y: auto;
        }

        .dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item.active {
            background: var(--primary);
            color: white;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .slider-container {
            margin: 20px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .slider-value {
            font-weight: bold;
            color: var(--success);
        }

        .range-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .range-slider::-webkit-slider-thumb:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 10px; 
            margin-top: 15px;
            flex-wrap: wrap; 
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0; 
        }

        .color-input {
            flex: 1; 
            min-width: 80px; 
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1rem;
        }

        input[type="color"] {
            width: 50px; 
            height: 40px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            flex-shrink: 0; 
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .action-buttons .btn {
            flex: 1;
            justify-content: center; 
        }

        .info-text {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .timer-input-container {
            display: flex;
            align-items: center; 
            gap: 10px;
            margin-top: 15px;
        }

        .timer-input-container label {
            min-width: 80px; 
            font-size: 1rem;
            white-space: nowrap;
        }
        
        .input-time {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1rem;
        }

        .settings-link {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--light);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }

        .settings-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .presence-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .presence-display .label {
            font-size: 1rem;
        }

        .presence-display .value {
            font-weight: bold;
            color: var(--success);
            font-size: 1.1rem;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        @media (max-width: 1200px) {
            .card-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .settings-link {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 15px;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .color-picker-container {
                gap: 15px;
                justify-content: space-between; 
            }
            
            .color-input {
                flex: 1 1 100%;
            }
            
            input[type="color"], .color-preview {
                flex-basis: auto; 
            }
        }
    </style>
</head>
<body>
    <div class="led-background">
        <div class="led-strip"></div>
        <div class="led-strip"></div>
        <div class="led-strip"></div>
        <div class="led-strip"></div>
        <div class="led-strip"></div>
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-lightbulb"></i> Lumina Control</h1>
            <p class="subtitle">Advanced LED Lighting Management System</p>
            <a href="settings.html" class="settings-link">
                <i class="fas fa-cog"></i> Settings
            </a>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="connectionStatus"></div>
                <span id="statusText">Connecting to device...</span>
            </div>
            <div class="status-item">
                <i class="fas fa-microchip"></i>
                <span>Device: <span id="currentDeviceId">friend1_leds</span></span>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-power-off"></i>
                    <h2>Power Control</h2>
                </div>
                <div class="toggle-container">
                    <span class="toggle-label">LED Strip Power</span>
                    <label class="toggle">
                        <input type="checkbox" id="powerToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <p class="info-text">
                    <i class="fas fa-info-circle"></i> Manually control the power state of the LED strip.
                </p>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clock"></i>
                    <h2>Timer Control</h2>
                </div>
                
                <div class="toggle-container" style="margin-bottom: 30px;">
                    <span class="toggle-label">Timer Enabled</span>
                    <label class="toggle">
                        <input type="checkbox" id="timerToggle">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="timer-input-container">
                    <label for="timerOnTimeInput">Time On:</label>
                    <input type="time" class="input-time" id="timerOnTimeInput" value="09:00">
                </div>

                <div class="timer-input-container">
                    <label for="timerOffTimeInput">Time Off:</label>
                    <input type="time" class="input-time" id="timerOffTimeInput" value="17:00">
                </div>
                
                <p class="info-text">
                    <i class="fas fa-info-circle"></i> Timer automatically powers the LED strip on and off at the set times.
                </p>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-user-check"></i>
                    <h2>Presence Sensor</h2>
                </div>
                <div class="presence-display">
                    <span class="label">Presence:</span>
                    <span class="value" id="presenceValue">--</span>
                </div>
                <p class="info-text">
                    <i class="fas fa-info-circle"></i> Live LD2410 presence detection state.
                </p>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-palette"></i>
                    <h2>Effects</h2>
                </div>
                <p>Select from 22 unique animation effects:</p>
                
                <div class="dropdown-container">
                    <div class="dropdown-header" id="dropdownHeader">
                        <span id="selectedEffect">Selecting Effect...</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </div>
                    <div class="dropdown-list" id="dropdownList">
                        <!-- Effects will be populated by JavaScript -->
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="calibrateMicBtn">
                        <i class="fas fa-microphone"></i> Calibrate Microphone
                    </button>
                </div>
                
                <p class="info-text">
                    <i class="fas fa-info-circle"></i> Calibrate microphone for audio-reactive effects.
                </p>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-tachometer-alt"></i>
                    <h2>Speed & Color</h2>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Animation Speed</span>
                        <span class="slider-value" id="speedValue">--</span>
                    </div>
                    <input type="range" min="10" max="200" value="50" class="range-slider" id="speedSlider">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px;">
                        <span>Fast</span>
                        <span>Slow</span>
                    </div>
                </div>

                <div class="color-picker-container">
                    <div class="color-preview" id="colorPreview" style="background-color: #FF0000;"></div>
                    <input type="color" class="color-input" id="colorPicker" value="#FF0000">
                    <input type="text" class="color-input" id="colorInput" value="" placeholder="Hex color">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="applyColorBtn">
                        <i class="fas fa-check"></i> Apply Color
                    </button>
                    <button class="btn btn-secondary" id="randomColorBtn">
                        <i class="fas fa-random"></i> Random
                    </button>
                </div>
                
                <p class="info-text">
                    <i class="fas fa-info-circle"></i> Select "Solid Color" effect and use the color picker to display a static color.
                </p>
            </div>
        </div>

        <footer>
            <p>Multi-Device Firebase Realtime Database Control</p>
        </footer>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-8dRf8a9y7v9y8z7x6w5v4u3y2i1o0p9",
            authDomain: "test-dbd7a-default-rtdb.firebaseapp.com",
            databaseURL: "https://test-dbd7a-default-rtdb.firebaseio.com",
            projectId: "test-dbd7a",
            storageBucket: "test-dbd7a.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const currentDeviceId = document.getElementById('currentDeviceId');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        const powerToggle = document.getElementById('powerToggle');
        const dropdownHeader = document.getElementById('dropdownHeader');
        const dropdownList = document.getElementById('dropdownList');
        const selectedEffect = document.getElementById('selectedEffect');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const colorPicker = document.getElementById('colorPicker');
        const colorInput = document.getElementById('colorInput');
        const colorPreview = document.getElementById('colorPreview');
        const applyColorBtn = document.getElementById('applyColorBtn');
        const randomColorBtn = document.getElementById('randomColorBtn');
        const timerToggle = document.getElementById('timerToggle');
        const timerOnTimeInput = document.getElementById('timerOnTimeInput');
        const timerOffTimeInput = document.getElementById('timerOffTimeInput');
        const presenceValue = document.getElementById('presenceValue');
        const calibrateMicBtn = document.getElementById('calibrateMicBtn');

        // Effect names matching the ESP32 code
        const effects = [
            "Rainbow Cycle", "Meteor Shower", "Digital Rain", "Pulsing Spheres", "Binary Clock",
            "Vortex", "DNA Helix", "Audio Visualizer", "Lava Lamp", "Radar Sweep",
            "Quantum Particles", "Neural Network", "Galaxy Spin", "Crystal Growth", "Lightning Storm",
            "Ocean Depth", "Northern Lights", "Time Tunnel", "Cyber City", "Solar Flare", "Fire Simulation",
            "Solid Color",
            "Frequency Spectrum", "Reactive Waveform", "Beat Pulse", "Frequency Bloom",
            "Audio Reactive Fire", "Musical Rainbow", "Reactive Strobe", "Guitar Visualizer",
            "Cascading Frequency", "Energy Orbits", "Audio Ripples"
        ];

        // Current state
        let currentState = {
            deviceId: "friend1_leds",
            basePath: "/devices/friend1_leds/",
            effect: 0,
            speed: 50,
            color: "FF0000",
            enabled: false,
            timer_enabled: true,
            timer_on: "09:00",
            timer_off: "17:00"
        };

        // Firebase listeners reference
        let firebaseListeners = [];

        // Set controls enabled/disabled state
        function setControlsEnabled(enabled) {
            const controls = [
                powerToggle,
                speedSlider, colorPicker, colorInput, applyColorBtn, randomColorBtn,
                timerToggle, timerOnTimeInput, timerOffTimeInput,
                calibrateMicBtn
            ];
            
            controls.forEach(control => {
                if (control) control.disabled = !enabled;
            });

            if (enabled) {
                dropdownHeader.style.cursor = 'pointer';
                dropdownHeader.style.opacity = '1';
            } else {
                dropdownHeader.style.cursor = 'not-allowed';
                dropdownHeader.style.opacity = '0.6';
                closeDropdown();
            }
        }

        // Remove all Firebase listeners
        function removeFirebaseListeners() {
            firebaseListeners.forEach(ref => {
                ref.off();
            });
            firebaseListeners = [];
        }

        // Update Firebase value with device path
        function updateFirebaseValue(path, value) {
            if (!currentState.basePath) return;
            
            const fullPath = currentState.basePath + path;
            database.ref(fullPath).set(value)
                .then(() => {
                    console.log(`Updated ${fullPath} to ${value}`);
                })
                .catch((error) => {
                    console.error(`Error updating ${fullPath}:`, error);
                });
        }

        // Generate random hex color
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Validate hex color
        function isValidHexColor(color) {
            return /^[0-9A-F]{6}$/i.test(color);
        }

        // Connect to device
        function connectToDevice(deviceId) {
            if (!deviceId || deviceId.trim() === '') {
                alert('Please enter a device ID');
                return;
            }

            // Remove previous listeners
            removeFirebaseListeners();

            // Set new device ID and base path
            currentState.deviceId = deviceId.trim();
            currentState.basePath = `/devices/${currentState.deviceId}/`;
            
            // Update UI
            currentDeviceId.textContent = currentState.deviceId;
            statusText.textContent = 'Connecting to device...';
            connectionStatus.className = 'status-indicator';
            
            // Enable controls
            setControlsEnabled(true);
            
            // Initialize Firebase listeners for the new device
            initializeFirebaseListeners();
            
            // Save to localStorage for convenience
            localStorage.setItem('lastDeviceId', currentState.deviceId);
        }

        // Initialize the dropdown
        function initializeDropdown() {
            dropdownList.innerHTML = '';
            effects.forEach((effect, index) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = effect;
                item.dataset.effectId = index;
                
                if (index === currentState.effect) {
                    item.classList.add('active');
                }
                
                item.addEventListener('click', () => {
                    if (!currentState.basePath) return;
                    
                    document.querySelectorAll('.dropdown-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    item.classList.add('active');
                    selectedEffect.textContent = effect;
                    updateFirebaseValue('effect', parseInt(item.dataset.effectId));
                    closeDropdown();
                });
                
                dropdownList.appendChild(item);
            });
        }

        // Toggle dropdown
        function toggleDropdown() {
            if (!currentState.basePath) return;
            
            if (dropdownList.classList.contains('show')) {
                closeDropdown();
            } else {
                openDropdown();
            }
        }

        // Open dropdown
        function openDropdown() {
            dropdownList.classList.add('show');
            dropdownHeader.classList.add('active');
        }

        // Close dropdown
        function closeDropdown() {
            dropdownList.classList.remove('show');
            dropdownHeader.classList.remove('active');
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Dropdown header click
            dropdownHeader.addEventListener('click', toggleDropdown);

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdownHeader.contains(e.target) && !dropdownList.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Power toggle
            powerToggle.addEventListener('change', () => {
                updateFirebaseValue('enabled', powerToggle.checked);
            });

            // Speed slider
            speedSlider.addEventListener('input', () => {
                speedValue.textContent = speedSlider.value;
            });

            speedSlider.addEventListener('change', () => {
                updateFirebaseValue('speed', parseInt(speedSlider.value));
            });

            // Color picker
            colorPicker.addEventListener('input', () => {
                const color = colorPicker.value.substring(1).toUpperCase();
                colorInput.value = color;
                colorPreview.style.backgroundColor = colorPicker.value;
            });

            // Color input
            colorInput.addEventListener('input', () => {
                const color = colorInput.value.toUpperCase();
                if (isValidHexColor(color)) {
                    colorPreview.style.backgroundColor = `#${color}`;
                    colorPicker.value = `#${color}`;
                }
            });

            // Apply color button
            applyColorBtn.addEventListener('click', () => {
                const color = colorInput.value.toUpperCase();
                if (isValidHexColor(color)) {
                    updateFirebaseValue('color', color);
                } else {
                    alert('Please enter a valid 6-digit hex color code (e.g., FF0000)');
                    colorInput.focus();
                }
            });

            // Random color button
            randomColorBtn.addEventListener('click', () => {
                const color = getRandomColor();
                colorInput.value = color;
                colorPreview.style.backgroundColor = `#${color}`;
                colorPicker.value = `#${color}`;
                updateFirebaseValue('color', color);
            });

            // Timer toggle
            timerToggle.addEventListener('change', () => {
                updateFirebaseValue('timer_enabled', timerToggle.checked);
            });

            // Timer on time input
            timerOnTimeInput.addEventListener('change', () => {
                updateFirebaseValue('timer_on', timerOnTimeInput.value);
            });

            // Timer off time input
            timerOffTimeInput.addEventListener('change', () => {
                updateFirebaseValue('timer_off', timerOffTimeInput.value);
            });

            // Microphone calibration button
            calibrateMicBtn.addEventListener('click', async () => {
                try {
                    calibrateMicBtn.disabled = true;
                    calibrateMicBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calibrating...';
                    if (!currentState.basePath) throw new Error('No device selected');
                    await database.ref(currentState.basePath + 'mic_calibration').set(true);
                    setTimeout(async () => {
                        await database.ref(currentState.basePath + 'mic_calibration').set(false);
                        calibrateMicBtn.disabled = false;
                        calibrateMicBtn.innerHTML = '<i class="fas fa-microphone"></i> Calibrate Microphone';
                    }, 20000);
                } catch (err) {
                    console.error('Mic calibration error:', err);
                    calibrateMicBtn.disabled = false;
                    calibrateMicBtn.innerHTML = '<i class="fas fa-microphone"></i> Calibrate Microphone';
                }
            });
        }

        // Initialize Firebase listeners
        function initializeFirebaseListeners() {
            if (!currentState.basePath) return;
            
            // Listen for connection status
            const connectedRef = database.ref(".info/connected");
            firebaseListeners.push(connectedRef);
            
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    statusText.textContent = 'Connected to Firebase';
                    connectionStatus.className = 'status-indicator connected';
                } else {
                    statusText.textContent = 'Disconnected from Firebase';
                    connectionStatus.className = 'status-indicator';
                }
            });

            // Listen for device data
            const deviceRef = database.ref(currentState.basePath);
            firebaseListeners.push(deviceRef);
            
            deviceRef.on("value", (snapshot) => {
                const data = snapshot.val();
                
                if (data) {
                    statusText.textContent = 'Connected to device';
                    connectionStatus.className = 'status-indicator connected';
                    
                    // Update UI with device data
                    if (data.enabled !== undefined) {
                        powerToggle.checked = data.enabled;
                        currentState.enabled = data.enabled;
                    }
                    
                    if (data.effect !== undefined) {
                        currentState.effect = data.effect;
                        selectedEffect.textContent = effects[data.effect] || 'Unknown Effect';
                        
                        // Update dropdown selection
                        document.querySelectorAll('.dropdown-item').forEach(item => {
                            item.classList.remove('active');
                            if (parseInt(item.dataset.effectId) === data.effect) {
                                item.classList.add('active');
                            }
                        });
                    }
                    
                    if (data.speed !== undefined) {
                        speedSlider.value = data.speed;
                        speedValue.textContent = data.speed;
                        currentState.speed = data.speed;
                    }
                    
                    if (data.color !== undefined) {
                        const color = data.color.toUpperCase();
                        colorInput.value = color;
                        colorPreview.style.backgroundColor = `#${color}`;
                        colorPicker.value = `#${color}`;
                        currentState.color = color;
                    }
                    
                    if (data.timer_enabled !== undefined) {
                        timerToggle.checked = data.timer_enabled;
                        currentState.timer_enabled = data.timer_enabled;
                    }
                    
                    if (data.timer_on !== undefined) {
                        timerOnTimeInput.value = data.timer_on;
                        currentState.timer_on = data.timer_on;
                    }
                    
                    if (data.timer_off !== undefined) {
                        timerOffTimeInput.value = data.timer_off;
                        currentState.timer_off = data.timer_off;
                    }
                    
                    if (data.presence !== undefined) {
                        presenceValue.textContent = data.presence ? 'YES' : 'NO';
                    }
                } else {
                    statusText.textContent = 'Device not found';
                    connectionStatus.className = 'status-indicator';
                    setControlsEnabled(false);
                }
            }, (error) => {
                console.error('Firebase error:', error);
                statusText.textContent = 'Error connecting to device';
                connectionStatus.className = 'status-indicator';
                setControlsEnabled(false);
            });
        }

        // Initialize the application
        function initializeApp() {
            // Initialize UI components
            initializeDropdown();
            initializeEventListeners();
            
            // Set initial state
            setControlsEnabled(false);
            
            // Set initial color preview
            colorPreview.style.backgroundColor = `#${currentState.color}`;
            
            // Try to load last used device ID
            const lastDeviceId = localStorage.getItem('lastDeviceId');
            if (lastDeviceId) {
                connectToDevice(lastDeviceId);
            }
        }

        // Start the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>