<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --danger: #f72585;
            --dark: #212529;
            --light: #f8f9fa;
            --gray: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* LED Background Effect */
        .led-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.15;
            pointer-events: none;
        }

        .led-strip {
            position: absolute;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff00, #00ff80, #00ffff, #0080ff, 
                #0000ff, #8000ff, #ff00ff, #ff0080);
            background-size: 1200% 100%;
            animation: led-animation 8s linear infinite;
            filter: blur(1px);
        }

        .led-strip:nth-child(2) {
            top: 20%;
            animation-delay: -1s;
        }

        .led-strip:nth-child(3) {
            top: 40%;
            animation-delay: -2s;
        }

        .led-strip:nth-child(4) {
            top: 60%;
            animation-delay: -3s;
        }

        .led-strip:nth-child(5) {
            top: 80%;
            animation-delay: -4s;
        }

        @keyframes led-animation {
            0% {
                background-position: 0% 0%;
            }
            100% {
                background-position: 100% 0%;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, 
                #ff0000, #ff8000, #ffff00, #80ff00, 
                #00ff00, #00ff80, #00ffff, #0080ff, 
                #0000ff, #8000ff, #ff00ff, #ff0080);
            background-size: 1200% 100%;
            animation: led-animation 8s linear infinite;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary), var(--success));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--gray);
        }

        /* Device ID Section */
        .device-id-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .device-id-container {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .device-id-label {
            font-size: 1.1rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .device-id-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1rem;
            transition: var(--transition);
        }

        .device-id-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.3);
        }

        .device-id-btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
        }

        .device-id-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .device-id-btn:disabled {
            background: var(--gray);
            cursor: not-allowed;
            transform: none;
        }

        .device-info {
            margin-top: 10px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--danger);
        }

        .status-indicator.connected {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--success));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.5s ease;
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-header i {
            font-size: 1.5rem;
            color: var(--primary);
        }

        h2 {
            font-size: 1.5rem;
        }

        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .toggle-label {
            font-size: 1.1rem;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray);
            transition: var(--transition);
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--success);
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        /* Custom Dropdown Styling */
        .dropdown-container {
            position: relative;
            margin-top: 15px;
            margin-bottom: 20px; 
        }

        .dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dropdown-header:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .dropdown-header.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-color: var(--primary);
        }

        .dropdown-arrow {
            transition: var(--transition);
        }

        .dropdown-header.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-list {
            background: rgba(30, 30, 46, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            z-index: 10; 
            backdrop-filter: blur(10px);
            margin-top: -1px; 
        }

        .dropdown-list.show {
            max-height: 250px;
            overflow-y: auto;
        }

        .dropdown-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .dropdown-item.active {
            background: var(--primary);
            color: white;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .slider-container {
            margin: 20px 0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .slider-value {
            font-weight: bold;
            color: var(--success);
        }

        .range-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }

        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            transition: var(--transition);
        }

        .range-slider::-webkit-slider-thumb:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 10px; 
            margin-top: 15px;
            flex-wrap: wrap; 
        }

        .color-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0; 
        }

        .color-input {
            flex: 1; 
            min-width: 80px; 
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1rem;
        }

        input[type="color"] {
            width: 50px; 
            height: 40px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            flex-shrink: 0; 
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 4px;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .action-buttons .btn {
            flex: 1;
            justify-content: center; 
        }

        .info-text {
            margin-top: 15px;
            font-size: 0.9rem;
            color: var(--gray);
        }

        .lux-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .lux-display .label {
            font-size: 1rem;
        }

        .lux-display .value {
            font-weight: bold;
            color: var(--success);
            font-size: 1.1rem;
        }

        .lux-input-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .lux-input-container label {
            font-size: 1rem;
            white-space: nowrap;
        }

        .lux-input {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1rem;
        }
        
        .timer-input-container {
            display: flex;
            align-items: center; 
            gap: 10px;
            margin-top: 15px;
        }

        .timer-input-container label {
            min-width: 80px; 
            font-size: 1rem;
            white-space: nowrap;
        }
        
        .input-time {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            font-size: 1rem;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        @media (max-width: 1200px) {
            .card-grid {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }

            .device-id-container {
                flex-direction: column;
                align-items: stretch;
            }

            .device-id-input {
                min-width: auto;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .card {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .color-picker-container {
                gap: 15px;
                justify-content: space-between; 
            }
            
            .color-input {
                flex: 1 1 100%;
            }
            
            input[type="color"], .color-preview {
                flex-basis: auto; 
            }
        }
    </style>
</head>
<body>
    <div class="led-background">
        <div class="led-strip"></div>
        <div class="led-strip"></div>
        <div class="led-strip"></div>
        <div class="led-strip"></div>
        <div class="led-strip"></div>
    </div>

    <div class="container">
        <header>
            <h1><i class="fas fa-lightbulb"></i> Lumina Control</h1>
            <p class="subtitle">Advanced LED Lighting Management System</p>
        </header>

        <!-- Device ID Section -->
        <div class="device-id-section">
            <div class="device-id-container">
                <span class="device-id-label">Device ID:</span>
                <input type="text" class="device-id-input" id="deviceIdInput" placeholder="Enter device ID (e.g., friend1_leds)" value="">
                <button class="device-id-btn" id="connectDeviceBtn">
                    <i class="fas fa-plug"></i> Connect to Device
                </button>
            </div>
            <div class="device-info">
                <i class="fas fa-info-circle"></i> Enter the device ID that matches your ESP32 configuration. Examples: friend1_leds, friend2_leds, etc.
            </div>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="connectionStatus"></div>
                <span id="statusText">Enter Device ID to Connect</span>
            </div>
            <div class="status-item">
                <i class="fas fa-microchip"></i>
                <span>Device: <span id="currentDeviceId">--</span></span>
            </div>
            <div class="status-item">
                <i class="fas fa-sun"></i>
                <span>Ambient Light: <span id="luxValue">--</span> lux</span>
            </div>
        </div>

        <div class="card-grid">
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-power-off"></i>
                    <h2>Power Control</h2>
                </div>
                <div class="toggle-container">
                    <span class="toggle-label">LED Strip Power</span>
                    <label class="toggle">
                        <input type="checkbox" id="powerToggle" disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="toggle-container">
                    <span class="toggle-label">Auto Darkness Control</span>
                    <label class="toggle">
                        <input type="checkbox" id="autoDarknessToggle" disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="lux-display">
                    <span class="label">Current Lux Level:</span>
                    <span class="value" id="currentLuxValue">--</span>
                </div>
                
                <div class="lux-input-container">
                    <label for="luxThresholdInput">Lux Threshold:</label>
                    <input type="number" min="0.1" step="0.1" value="1.0" class="lux-input" id="luxThresholdInput" disabled>
                </div>
                
                <p class="info-text">
                    <i class="fas fa-info-circle"></i> Auto darkness control turns off LEDs when ambient light is below threshold.
                </p>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clock"></i>
                    <h2>Timer Control</h2>
                </div>
                
                <div class="toggle-container" style="margin-bottom: 30px;">
                    <span class="toggle-label">Timer Enabled</span>
                    <label class="toggle">
                        <input type="checkbox" id="timerToggle" disabled>
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="timer-input-container">
                    <label for="timerOnTimeInput">Time On:</label>
                    <input type="time" class="input-time" id="timerOnTimeInput" value="09:00" disabled>
                </div>

                <div class="timer-input-container">
                    <label for="timerOffTimeInput">Time Off:</label>
                    <input type="time" class="input-time" id="timerOffTimeInput" value="17:00" disabled>
                </div>
                
                <p class="info-text">
                    <i class="fas fa-info-circle"></i> Timer automatically powers the LED strip on and off at the set times.
                </p>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-palette"></i>
                    <h2>Effects</h2>
                </div>
                <p>Select from 22 unique animation effects:</p>
                
                <div class="dropdown-container">
                    <div class="dropdown-header" id="dropdownHeader">
                        <span id="selectedEffect">Select Device First</span>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </div>
                    <div class="dropdown-list" id="dropdownList">
                        <!-- Effects will be populated here -->
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <i class="fas fa-tachometer-alt"></i>
                    <h2>Speed & Color</h2>
                </div>
                
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Animation Speed</span>
                        <span class="slider-value" id="speedValue">--</span>
                    </div>
                    <input type="range" min="10" max="200" value="50" class="range-slider" id="speedSlider" disabled>
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px;">
                        <span>Fast</span>
                        <span>Slow</span>
                    </div>
                </div>

                <div class="color-picker-container">
                    <div class="color-preview" id="colorPreview" style="background-color: #333333;"></div>
                    <input type="color" class="color-input" id="colorPicker" value="#333333" disabled>
                    <input type="text" class="color-input" id="colorInput" value="" placeholder="Hex color" disabled>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" id="applyColorBtn" disabled>
                        <i class="fas fa-check"></i> Apply Color
                    </button>
                    <button class="btn btn-secondary" id="randomColorBtn" disabled>
                        <i class="fas fa-random"></i> Random
                    </button>
                </div>
                
                <p class="info-text">
                    <i class="fas fa-info-circle"></i> Select "Solid Color" effect and use the color picker to display a static color.
                </p>
            </div>
        </div>

        <footer>
            <p>Multi-Device Firebase Realtime Database Control</p>
        </footer>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-8dRf8a9y7v9y8z7x6w5v4u3y2i1o0p9",
            authDomain: "test-dbd7a-default-rtdb.firebaseapp.com",
            databaseURL: "https://test-dbd7a-default-rtdb.firebaseio.com",
            projectId: "test-dbd7a",
            storageBucket: "test-dbd7a.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const deviceIdInput = document.getElementById('deviceIdInput');
        const connectDeviceBtn = document.getElementById('connectDeviceBtn');
        const currentDeviceId = document.getElementById('currentDeviceId');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        const powerToggle = document.getElementById('powerToggle');
        const autoDarknessToggle = document.getElementById('autoDarknessToggle');
        const dropdownHeader = document.getElementById('dropdownHeader');
        const dropdownList = document.getElementById('dropdownList');
        const selectedEffect = document.getElementById('selectedEffect');
        const speedSlider = document.getElementById('speedSlider');
        const speedValue = document.getElementById('speedValue');
        const colorPicker = document.getElementById('colorPicker');
        const colorInput = document.getElementById('colorInput');
        const colorPreview = document.getElementById('colorPreview');
        const applyColorBtn = document.getElementById('applyColorBtn');
        const randomColorBtn = document.getElementById('randomColorBtn');
        const luxThresholdInput = document.getElementById('luxThresholdInput');
        const currentLuxValue = document.getElementById('currentLuxValue');
        const luxValue = document.getElementById('luxValue');
        const timerToggle = document.getElementById('timerToggle');
        const timerOnTimeInput = document.getElementById('timerOnTimeInput');
        const timerOffTimeInput = document.getElementById('timerOffTimeInput');

        // Effect names matching the ESP32 code
        const effects = [
            "Rainbow Cycle", "Meteor Shower", "Digital Rain", "Pulsing Spheres", "Binary Clock",
            "Vortex", "DNA Helix", "Audio Visualizer", "Lava Lamp", "Radar Sweep",
            "Quantum Particles", "Neural Network", "Galaxy Spin", "Crystal Growth", "Lightning Storm",
            "Ocean Depth", "Northern Lights", "Time Tunnel", "Cyber City", "Solar Flare", "Fire Simulation",
            "Solid Color"
        ];

        // Current state
        let currentState = {
            deviceId: null,
            basePath: null,
            effect: 0,
            speed: 50,
            color: "FF0000",
            enabled: false,
            auto_darkness_control: false,
            lux_threshold: 1.0,
            timer_enabled: true,
            timer_on_time: "09:00",
            timer_off_time: "17:00"
        };

        // Firebase listeners reference
        let firebaseListeners = [];

        // Set controls enabled/disabled state
        function setControlsEnabled(enabled) {
            const controls = [
                powerToggle, autoDarknessToggle, luxThresholdInput,
                speedSlider, colorPicker, colorInput, applyColorBtn, randomColorBtn,
                timerToggle, timerOnTimeInput, timerOffTimeInput
            ];
            
            controls.forEach(control => {
                control.disabled = !enabled;
            });

            if (enabled) {
                dropdownHeader.style.cursor = 'pointer';
                dropdownHeader.style.opacity = '1';
            } else {
                dropdownHeader.style.cursor = 'not-allowed';
                dropdownHeader.style.opacity = '0.6';
                closeDropdown();
            }
        }

        // Remove all Firebase listeners
        function removeFirebaseListeners() {
            firebaseListeners.forEach(ref => {
                ref.off();
            });
            firebaseListeners = [];
        }

        // Update Firebase value with device path
        function updateFirebaseValue(path, value) {
            if (!currentState.basePath) return;
            
            const fullPath = currentState.basePath + path;
            database.ref(fullPath).set(value)
                .then(() => {
                    console.log(`Updated ${fullPath} to ${value}`);
                })
                .catch((error) => {
                    console.error(`Error updating ${fullPath}:`, error);
                });
        }

        // Generate random hex color
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Validate hex color
        function isValidHexColor(color) {
            return /^[0-9A-F]{6}$/i.test(color);
        }

        // Connect to device
        function connectToDevice(deviceId) {
            if (!deviceId || deviceId.trim() === '') {
                alert('Please enter a device ID');
                return;
            }

            // Remove previous listeners
            removeFirebaseListeners();

            // Set new device ID and base path
            currentState.deviceId = deviceId.trim();
            currentState.basePath = `/devices/${currentState.deviceId}/`;
            
            // Update UI
            currentDeviceId.textContent = currentState.deviceId;
            statusText.textContent = 'Connecting to device...';
            connectionStatus.className = 'status-indicator';
            
            // Enable controls
            setControlsEnabled(true);
            
            // Initialize Firebase listeners for the new device
            initializeFirebaseListeners();
            
            // Save to localStorage for convenience
            localStorage.setItem('lastDeviceId', currentState.deviceId);
        }

        // Initialize the dropdown
        function initializeDropdown() {
            dropdownList.innerHTML = '';
            effects.forEach((effect, index) => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = effect;
                item.dataset.effectId = index;
                
                if (index === currentState.effect) {
                    item.classList.add('active');
                }
                
                item.addEventListener('click', () => {
                    if (!currentState.basePath) return;
                    
                    document.querySelectorAll('.dropdown-item').forEach(el => {
                        el.classList.remove('active');
                    });
                    item.classList.add('active');
                    selectedEffect.textContent = effect;
                    updateFirebaseValue('effect', parseInt(item.dataset.effectId));
                    closeDropdown();
                });
                
                dropdownList.appendChild(item);
            });
        }

        // Toggle dropdown
        function toggleDropdown() {
            if (!currentState.basePath) return;
            
            if (dropdownList.classList.contains('show')) {
                closeDropdown();
            } else {
                openDropdown();
            }
        }

        // Open dropdown
        function openDropdown() {
            dropdownList.classList.add('show');
            dropdownHeader.classList.add('active');
        }

        // Close dropdown
        function closeDropdown() {
            dropdownList.classList.remove('show');
            dropdownHeader.classList.remove('active');
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Device ID input
            deviceIdInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    connectToDevice(deviceIdInput.value);
                }
            });

            // Connect device button
            connectDeviceBtn.addEventListener('click', () => {
                connectToDevice(deviceIdInput.value);
            });

            // Dropdown header click
            dropdownHeader.addEventListener('click', toggleDropdown);

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!dropdownHeader.contains(e.target) && !dropdownList.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Power toggle
            powerToggle.addEventListener('change', () => {
                updateFirebaseValue('enabled', powerToggle.checked);
            });

            // Auto darkness toggle
            autoDarknessToggle.addEventListener('change', () => {
                updateFirebaseValue('auto_darkness_control', autoDarknessToggle.checked);
            });

            // Lux threshold input
            luxThresholdInput.addEventListener('change', () => {
                let value = parseFloat(luxThresholdInput.value);
                value = Math.max(0, value);
                luxThresholdInput.value = value.toFixed(1);
                updateFirebaseValue('lux_threshold', value);
            });

            // Speed slider
            speedSlider.addEventListener('input', () => {
                speedValue.textContent = speedSlider.value;
            });

            speedSlider.addEventListener('change', () => {
                updateFirebaseValue('speed', parseInt(speedSlider.value));
            });

            // Color picker
            colorPicker.addEventListener('input', () => {
                const color = colorPicker.value.substring(1).toUpperCase();
                colorInput.value = color;
                colorPreview.style.backgroundColor = colorPicker.value;
            });

            // Color input
            colorInput.addEventListener('input', () => {
                const color = colorInput.value.toUpperCase();
                if (isValidHexColor(color)) {
                    colorPreview.style.backgroundColor = `#${color}`;
                    colorPicker.value = `#${color}`;
                }
            });

            // Apply color button
            applyColorBtn.addEventListener('click', () => {
                const color = colorInput.value.toUpperCase();
                if (isValidHexColor(color)) {
                    updateFirebaseValue('color', color);
                } else {
                    alert('Please enter a valid 6-digit hex color code (e.g., FF0000)');
                    colorInput.focus();
                }
            });

            // Random color button
            randomColorBtn.addEventListener('click', () => {
                const randomColor = getRandomColor();
                colorInput.value = randomColor;
                colorPreview.style.backgroundColor = `#${randomColor}`;
                colorPicker.value = `#${randomColor}`;
                updateFirebaseValue('color', randomColor);
            });
            
            // Timer toggle
            timerToggle.addEventListener('change', () => {
                updateFirebaseValue('timer_enabled', timerToggle.checked);
            });

            // Time On Input
            timerOnTimeInput.addEventListener('change', () => {
                updateFirebaseValue('timer_on', timerOnTimeInput.value);
            });
            
            // Time Off Input
            timerOffTimeInput.addEventListener('change', () => {
                updateFirebaseValue('timer_off', timerOffTimeInput.value);
            });
        }

        // Listen for Firebase value changes
        function initializeFirebaseListeners() {
            if (!currentState.basePath) return;

            // Effect
            const effectRef = database.ref(currentState.basePath + 'effect');
            effectRef.on('value', (snapshot) => {
                const effect = snapshot.val();
                if (effect !== null) {
                    currentState.effect = effect;
                    selectedEffect.textContent = effects[effect] || 'Unknown Effect';
                    document.querySelectorAll('.dropdown-item').forEach(item => {
                        item.classList.remove('active');
                        if (parseInt(item.dataset.effectId) === effect) {
                            item.classList.add('active');
                        }
                    });
                }
            });
            firebaseListeners.push(effectRef);

            // Speed
            const speedRef = database.ref(currentState.basePath + 'speed');
            speedRef.on('value', (snapshot) => {
                const speed = snapshot.val();
                if (speed !== null) {
                    currentState.speed = speed;
                    speedSlider.value = speed;
                    speedValue.textContent = speed;
                }
            });
            firebaseListeners.push(speedRef);

            // Color
            const colorRef = database.ref(currentState.basePath + 'color');
            colorRef.on('value', (snapshot) => {
                const color = snapshot.val();
                if (color !== null) {
                    currentState.color = color;
                    colorInput.value = color;
                    colorPreview.style.backgroundColor = `#${color}`;
                    colorPicker.value = `#${color}`;
                }
            });
            firebaseListeners.push(colorRef);

            // Enabled
            const enabledRef = database.ref(currentState.basePath + 'enabled');
            enabledRef.on('value', (snapshot) => {
                const enabled = snapshot.val();
                if (enabled !== null) {
                    currentState.enabled = enabled;
                    powerToggle.checked = enabled;
                }
            });
            firebaseListeners.push(enabledRef);

            // Auto darkness control
            const autoDarknessRef = database.ref(currentState.basePath + 'auto_darkness_control');
            autoDarknessRef.on('value', (snapshot) => {
                const autoDarkness = snapshot.val();
                if (autoDarkness !== null) {
                    currentState.auto_darkness_control = autoDarkness;
                    autoDarknessToggle.checked = autoDarkness;
                }
            });
            firebaseListeners.push(autoDarknessRef);

            // Lux threshold
            const luxThresholdRef = database.ref(currentState.basePath + 'lux_threshold');
            luxThresholdRef.on('value', (snapshot) => {
                const threshold = snapshot.val();
                if (threshold !== null) {
                    currentState.lux_threshold = threshold;
                    luxThresholdInput.value = threshold.toFixed(1);
                }
            });
            firebaseListeners.push(luxThresholdRef);
            
            // Timer Enabled
            const timerEnabledRef = database.ref(currentState.basePath + 'timer_enabled');
            timerEnabledRef.on('value', (snapshot) => {
                const enabled = snapshot.val();
                if (enabled !== null) {
                    currentState.timer_enabled = enabled;
                    timerToggle.checked = enabled;
                }
            });
            firebaseListeners.push(timerEnabledRef);

            // Time On
            const timerOnRef = database.ref(currentState.basePath + 'timer_on');
            timerOnRef.on('value', (snapshot) => {
                const time = snapshot.val();
                if (time !== null) {
                    currentState.timer_on_time = time;
                    timerOnTimeInput.value = time;
                }
            });
            firebaseListeners.push(timerOnRef);

            // Time Off
            const timerOffRef = database.ref(currentState.basePath + 'timer_off');
            timerOffRef.on('value', (snapshot) => {
                const time = snapshot.val();
                if (time !== null) {
                    currentState.timer_off_time = time;
                    timerOffTimeInput.value = time;
                }
            });
            firebaseListeners.push(timerOffRef);

            // Lux value
            const luxRef = database.ref(currentState.basePath + 'lux');
            luxRef.on('value', (snapshot) => {
                const lux = snapshot.val();
                if (lux !== null) {
                    luxValue.textContent = lux.toFixed(2);
                    currentLuxValue.textContent = lux.toFixed(2);
                }
            });
            firebaseListeners.push(luxRef);

            // Connection status
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                if (snapshot.val() === true && currentState.basePath) {
                    connectionStatus.className = 'status-indicator connected';
                    statusText.textContent = `Connected to ${currentState.deviceId}`;
                } else {
                    connectionStatus.className = 'status-indicator';
                    statusText.textContent = 'Disconnected from Firebase';
                }
            });
            firebaseListeners.push(connectedRef);
        }

        // Initialize the application
        function initializeApp() {
            initializeDropdown();
            initializeEventListeners();
            setControlsEnabled(false);
            
            // Try to load last used device ID
            const lastDeviceId = localStorage.getItem('lastDeviceId');
            if (lastDeviceId) {
                deviceIdInput.value = lastDeviceId;
            }
            
            // Set initial color preview
            colorPreview.style.backgroundColor = '#333333';
        }

        // Start the application when the page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>