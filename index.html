<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumina Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --bg-body: #050505;
            --bg-card: #121212;
            --bg-card-hover: #1a1a1a;
            --bg-input: #2a2a2a;
            
            --primary: #3b82f6;
            --primary-glow: rgba(59, 130, 246, 0.4);
            --secondary: #8b5cf6;
            --accent: #f43f5e;
            --success: #10b981;
            
            --text-main: #ffffff;
            --text-secondary: #a3a3a3;
            
            --border-light: rgba(255, 255, 255, 0.1);
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 8px;
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
            overflow-x: hidden;
        }

        /* Ambient Background */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            opacity: 0.4;
            animation: float 20s infinite ease-in-out;
        }
        .orb-1 {
            top: -10%; left: -10%; width: 50vw; height: 50vw;
            background: radial-gradient(circle, var(--primary), transparent 70%);
        }
        .orb-2 {
            bottom: -10%; right: -10%; width: 60vw; height: 60vw;
            background: radial-gradient(circle, var(--secondary), transparent 70%);
            animation-delay: -10s;
        }
        @keyframes float {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(30px, -30px); }
        }

        .container {
            width: 100%;
            max-width: 1100px;
            z-index: 1;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding: 0 10px;
        }
        
        .brand {
            display: flex;
            flex-direction: column;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
            letter-spacing: -1px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 400;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-light);
            color: var(--text-main);
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .status-chip {
            background: var(--bg-card);
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }
        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.4);
        }

        /* Card System */
        .card {
            background: rgba(18, 18, 18, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-bottom: 24px;
            transition: var(--transition);
        }
        
        .card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .card-header i {
            color: var(--primary);
            font-size: 1.2rem;
            background: rgba(59, 130, 246, 0.1);
            padding: 10px;
            border-radius: 12px;
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        /* Grid Layout */
        .grid-layout {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
        }

        /* Device Buttons */
        .node-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .node-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 16px 20px;
            color: var(--text-main);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 160px;
            text-align: left;
        }

        .node-btn:hover {
            background: rgba(255,255,255,0.08);
        }

        .node-btn.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.2);
        }

        .node-btn i { font-size: 1.2rem; }
        .node-info { display: flex; flex-direction: column; }
        .node-name { font-weight: 600; font-size: 0.95rem; }
        .node-status { font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; }

        /* Controls */
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .control-row:last-child { border-bottom: none; }
        
        .control-label { font-size: 1rem; font-weight: 500; }
        .control-sub { font-size: 0.85rem; color: var(--text-secondary); }

        /* Toggle Switch */
        .toggle {
            position: relative;
            width: 52px;
            height: 28px;
        }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-input);
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: "";
            height: 20px; width: 20px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* Inputs */
        .time-inputs {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .time-input {
            flex: 1;
            background: var(--bg-input);
            border: 1px solid transparent;
            color: var(--text-main);
            padding: 10px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            outline: none;
            transition: var(--transition);
        }
        .time-input:focus { border-color: var(--primary); }

        /* Dropdown */
        .dropdown-container { position: relative; width: 100%; margin: 10px 0 20px; }
        .dropdown-header {
            background: var(--bg-input);
            padding: 14px 20px;
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }
        .dropdown-header:hover { background: rgba(255,255,255,0.1); }
        
        .dropdown-list {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: #1e1e1e;
            border-radius: var(--radius-md);
            margin-top: 8px;
            max-height: 0;
            overflow: hidden;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            border: 1px solid var(--border-light);
        }
        .dropdown-list.show { max-height: 300px; padding: 5px; }
        
        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            border-radius: 8px;
            color: var(--text-secondary);
            transition: var(--transition);
        }
        .dropdown-item:hover { background: var(--primary); color: white; }

        /* Range Slider */
        input[type=range] {
            width: 100%;
            height: 6px;
            background: var(--bg-input);
            border-radius: 5px;
            outline: none;
            -webkit-appearance: none;
            margin: 15px 0;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px; height: 20px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(1.2); }

        /* Color Picker */
        .color-controls {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg-input);
            padding: 10px;
            border-radius: var(--radius-md);
        }
        .color-preview {
            width: 48px; height: 48px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 2px solid rgba(255,255,255,0.1);
        }
        #colorPicker {
            flex: 1;
            height: 40px;
            border: none;
            background: transparent;
            cursor: pointer;
        }
        .btn-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            border: none;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: var(--transition);
        }
        .btn-icon:hover { background: rgba(255,255,255,0.2); }

        /* Primary Button */
        .btn-primary {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        .btn-primary:hover {
            background: #2563eb;
            box-shadow: 0 4px 12px var(--primary-glow);
            transform: translateY(-2px);
        }

        /* Footer */
        footer { text-align: center; margin-top: 40px; color: var(--text-secondary); font-size: 0.9rem; opacity: 0.6; }

        @media (max-width: 768px) {
            .grid-layout { grid-template-columns: 1fr; }
            h1 { font-size: 2rem; }
            body { padding: 20px 15px; }
        }
    </style>
</head>
<body>
    <div class="ambient-bg">
        <div class="orb orb-1"></div>
        <div class="orb orb-2"></div>
    </div>

    <div class="container">
        <header>
            <div class="brand">
                <h1>Lumina Control</h1>
                <span class="subtitle">Advanced Multi-Device Command Center</span>
            </div>
            <a href="settings.html" class="settings-btn"><i class="fas fa-cog"></i></a>
        </header>

        <div class="status-bar">
            <div class="status-chip">
                <div class="status-dot" id="connectionStatus"></div>
                <span id="statusText">Connecting...</span>
            </div>
            <div class="status-chip">
                <i class="fas fa-microchip"></i>
                <span>ID: <span id="currentDeviceId">--</span></span>
            </div>
        </div>

        <!-- Device Registry -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-network-wired"></i>
                <h2>Device Network</h2>
            </div>
            <div id="nodeList" class="node-list">
                <button class="node-btn active" data-target="local">
                    <i class="fas fa-server"></i>
                    <div class="node-info">
                        <span class="node-name">Gateway</span>
                        <span class="node-status">Main Controller</span>
                    </div>
                </button>
            </div>
        </div>

        <div class="grid-layout">
            <!-- Power & Sync -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-power-off"></i>
                    <h2>Power & Sync</h2>
                </div>
                
                <div class="control-row">
                    <div>
                        <div class="control-label">Master Power</div>
                        <div class="control-sub">Toggle all connected LEDs</div>
                    </div>
                    <label class="toggle"><input type="checkbox" id="powerToggle"><span class="slider"></span></label>
                </div>

                <div id="mirrorControlContainer" class="control-row" style="display: none;">
                    <div>
                        <div class="control-label">Mirror Gateway</div>
                        <div class="control-sub">Sync with main controller</div>
                    </div>
                    <label class="toggle"><input type="checkbox" id="mirrorToggle"><span class="slider"></span></label>
                </div>

                <div style="border-top: 1px solid var(--border-light); margin: 15px 0; padding-top: 15px;">
                    <div class="control-row">
                        <div class="control-label">Schedule Timer</div>
                        <label class="toggle"><input type="checkbox" id="timerToggle"><span class="slider"></span></label>
                    </div>
                    <div class="time-inputs">
                        <input type="time" id="timerOnTimeInput" class="time-input" title="Turn On Time">
                        <input type="time" id="timerOffTimeInput" class="time-input" title="Turn Off Time">
                    </div>
                </div>
            </div>

            <!-- Effects & Color -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-palette"></i>
                    <h2>Visual Effects</h2>
                </div>
                
                <div class="dropdown-container">
                    <div class="dropdown-header" id="dropdownHeader">
                        <span id="selectedEffect">Select Effect</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="dropdown-list" id="dropdownList"></div>
                </div>

                <div style="margin: 20px 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span class="control-label">Master Brightness</span>
                        <span id="brightnessValue" style="color:var(--primary); font-family:monospace;">255</span>
                    </div>
                    <input type="range" min="0" max="255" value="255" id="brightnessSlider">
                </div>

                <div style="margin: 20px 0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span class="control-label">Animation Speed</span>
                        <span id="speedValue" style="color:var(--primary); font-family:monospace;">50</span>
                    </div>
                    <input type="range" min="10" max="200" value="50" id="speedSlider">
                </div>

                <div class="color-controls">
                    <div class="color-preview" id="colorPreview"></div>
                    <input type="color" id="colorPicker" value="#FF0000">
                    <button class="btn-icon" id="randomColorBtn"><i class="fas fa-random"></i></button>
                </div>
            </div>

            <!-- Sensors -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-wave-square"></i>
                    <h2>Sensors & Audio</h2>
                </div>
                
                <div style="background: var(--bg-input); padding: 20px; border-radius: var(--radius-md); text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">Human Presence</div>
                    <div id="presenceValue" style="font-size: 1.5rem; font-weight: 700; color: var(--success);">--</div>
                </div>

                <button class="btn-primary" id="calibrateMicBtn">
                    <i class="fas fa-microphone-lines"></i> Calibrate Microphone
                </button>
            </div>
        </div>

        <footer>
            &copy; 2026 Lumina Inc. All rights reserved.
        </footer>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC-8dRf8a9y7v9y8z7x6w5v4u3y2i1o0p9",
            authDomain: "test-dbd7a-default-rtdb.firebaseapp.com",
            databaseURL: "https://test-dbd7a-default-rtdb.firebaseio.com",
            projectId: "test-dbd7a",
            storageBucket: "test-dbd7a.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef123456"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const effects = [
            // Standard (0-21)
            "Rainbow Cycle", "Meteor Shower", "Digital Rain", "Pulsing Spheres", "Binary Clock", "Vortex", "DNA Helix", "Audio Visualizer", "Lava Lamp", "Radar Sweep", "Quantum Particles", "Neural Network", "Galaxy Spin", "Crystal Growth", "Lightning Storm", "Ocean Depth", "Northern Lights", "Time Tunnel", "Cyber City", "Solar Flare", "Fire Simulation", "Solid Color",
            // Sound Reactive (22-32)
            "Frequency Spectrum", "Reactive Waveform", "Beat Pulse", "Frequency Bloom", "Audio Reactive Fire", "Musical Rainbow", "Reactive Strobe", "Guitar Visualizer", "Cascading Frequency", "Energy Orbits", "Audio Ripples",
            // Revolutionary (33-42)
            "Plasma Waves", "Confetti Palettes", "Sinelon Dual", "BPM", "Juggle", "Glitter Rainbow", "Pacific", "Twinkle Fox", "Color Waves", "Perlin Move",
            // Organic Lamps (43-52)
            "Plasma Lamp", "Bioluminescence", "Deep Sea Volcano", "Magical Aurora", "Solar Winds", "Ethereal Mist", "Bio-Pulse", "Radioactive Glow", "Supernova", "Enchanted Stream",
            // Fire Simulations (53-62)
            "Blue Gas Flame", "Wildfire", "Candle Flame", "Campfire", "Plasma Fire", "Inferno", "Smoldering Embers", "Lava Flow", "Ember Storm", "Hearth Fire"
        ];

        const effectCategories = [
            { name: "âœ¨ Standard", start: 0, end: 21 },
            { name: "ðŸŽµ Sound Reactive", start: 22, end: 32 },
            { name: "ðŸš€ Revolutionary", start: 33, end: 42 },
            { name: "ðŸ’¡ Organic Lamps", start: 43, end: 52 },
            { name: "ðŸ”¥ Fire Simulations", start: 53, end: 62 }
        ];

        let currentState = {
            deviceId: localStorage.getItem('lastDeviceId') || 'friend1_leds',
            currentTarget: 'local',
            activeNodes: {}
        };

        const nodeList = document.getElementById('nodeList');
        const mirrorToggle = document.getElementById('mirrorToggle');
        const mirrorControlContainer = document.getElementById('mirrorControlContainer');
        const powerToggle = document.getElementById('powerToggle');
        const speedSlider = document.getElementById('speedSlider');
        const brightnessSlider = document.getElementById('brightnessSlider');
        const colorPicker = document.getElementById('colorPicker');
        const dropdownHeader = document.getElementById('dropdownHeader');
        const dropdownList = document.getElementById('dropdownList');

        function updateFirebaseValue(path, value) {
            if (!currentState.deviceId) return;
            const base = `/devices/${currentState.deviceId}/`;
            const target = currentState.currentTarget === 'local' ? 'local' : `receivers/${currentState.currentTarget}`;
            const fullPath = base + target + '/' + path;
            database.ref(fullPath).set(value);
        }

        let firebaseListeners = [];
        function removeListeners() {
            firebaseListeners.forEach(ref => ref.off());
            firebaseListeners = [];
        }

        function initListeners() {
            if (!currentState.deviceId) return;
            removeListeners();
            const base = `/devices/${currentState.deviceId}/`;
            
            // Discovery
            const activeRef = database.ref(base + 'active_nodes');
            firebaseListeners.push(activeRef);
            activeRef.on('value', snap => {
                currentState.activeNodes = snap.val() || {};
                const gatewayBtn = nodeList.querySelector('[data-target="local"]');
                nodeList.innerHTML = '';
                nodeList.appendChild(gatewayBtn);
                Object.keys(currentState.activeNodes).forEach(mac => {
                    const btn = document.createElement('button');
                    btn.className = `node-btn ${currentState.currentTarget === mac ? 'active' : ''}`;
                    btn.dataset.target = mac;
                    btn.innerHTML = `<i class="fas fa-lightbulb"></i>
                                     <div class="node-info">
                                         <span class="node-name">Receiver</span>
                                         <span class="node-status">${mac}</span>
                                     </div>`;
                    nodeList.appendChild(btn);
                });
            });

            // Target state
            const target = currentState.currentTarget === 'local' ? 'local' : `receivers/${currentState.currentTarget}`;
            const targetRef = database.ref(base + target);
            firebaseListeners.push(targetRef);

            mirrorControlContainer.style.display = (currentState.currentTarget === 'local') ? 'none' : 'flex';

            targetRef.on('value', snap => {
                const data = snap.val();
                if (!data) return;
                
                powerToggle.checked = !!data.enabled;
                if (data.isMirror !== undefined) mirrorToggle.checked = !!data.isMirror;
                
                speedSlider.value = data.speed || 50;
                document.getElementById('speedValue').textContent = data.speed || 50;

                brightnessSlider.value = data.brightness !== undefined ? data.brightness : 255;
                document.getElementById('brightnessValue').textContent = brightnessSlider.value;
                
                const color = data.color || "FF0000";
                colorPicker.value = '#' + color;
                document.getElementById('colorPreview').style.backgroundColor = '#' + color;
                
                document.getElementById('selectedEffect').textContent = effects[data.effect] || 'Rainbow Cycle';
                
                document.getElementById('connectionStatus').className = 'status-dot connected';
                document.getElementById('statusText').textContent = 'Online';
            });

            // Timers & Sensors (Always from Local)
            const localRef = database.ref(base + 'local');
            firebaseListeners.push(localRef);
            localRef.on('value', snap => {
                const data = snap.val();
                if (!data) return;
                document.getElementById('timerToggle').checked = !!data.timer_enabled;
                document.getElementById('timerOnTimeInput').value = data.timer_on || "09:00";
                document.getElementById('timerOffTimeInput').value = data.timer_off || "17:00";
                
                if (data.sensor_stats && data.sensor_stats.sensors) {
                    document.getElementById('presenceValue').textContent = data.sensor_stats.sensors.presence ? 'Detected' : 'Clear';
                }
            });
        }

        nodeList.addEventListener('click', e => {
            const btn = e.target.closest('.node-btn');
            if (!btn) return;
            document.querySelectorAll('.node-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentState.currentTarget = btn.dataset.target;
            initListeners();
        });

        powerToggle.addEventListener('change', () => updateFirebaseValue('enabled', powerToggle.checked));
        mirrorToggle.addEventListener('change', () => updateFirebaseValue('isMirror', mirrorToggle.checked));
        speedSlider.addEventListener('input', () => document.getElementById('speedValue').textContent = speedSlider.value);
        speedSlider.addEventListener('change', () => updateFirebaseValue('speed', parseInt(speedSlider.value)));
        
        brightnessSlider.addEventListener('input', () => document.getElementById('brightnessValue').textContent = brightnessSlider.value);
        brightnessSlider.addEventListener('change', () => updateFirebaseValue('brightness', parseInt(brightnessSlider.value)));

        colorPicker.addEventListener('change', () => {
            const color = colorPicker.value.substring(1).toUpperCase();
            document.getElementById('colorPreview').style.backgroundColor = '#' + color;
            updateFirebaseValue('color', color);
        });
        
        document.getElementById('timerToggle').addEventListener('change', (e) => updateFirebaseValue('timer_enabled', e.target.checked));
        document.getElementById('timerOnTimeInput').addEventListener('change', (e) => updateFirebaseValue('timer_on', e.target.value));
        document.getElementById('timerOffTimeInput').addEventListener('change', (e) => updateFirebaseValue('timer_off', e.target.value));

        dropdownHeader.addEventListener('click', () => dropdownList.classList.toggle('show'));
        
        // Categorized dropdown generation
        dropdownList.innerHTML = '';
        effectCategories.forEach(cat => {
            const catHeader = document.createElement('div');
            catHeader.style.padding = '8px 12px';
            catHeader.style.color = 'var(--primary)';
            catHeader.style.fontSize = '0.8rem';
            catHeader.style.fontWeight = 'bold';
            catHeader.style.textTransform = 'uppercase';
            catHeader.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
            catHeader.textContent = cat.name;
            dropdownList.appendChild(catHeader);

            for(let i = cat.start; i <= cat.end; i++) {
                if (i >= effects.length) break;
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = effects[i];
                item.onclick = () => {
                    updateFirebaseValue('effect', i);
                    dropdownList.classList.remove('show');
                };
                dropdownList.appendChild(item);
            }
        });

        document.getElementById('calibrateMicBtn').addEventListener('click', () => {
            const base = `/devices/${currentState.deviceId}/local/`;
            database.ref(base + 'mic_calibration').set(true);
            setTimeout(() => database.ref(base + 'mic_calibration').set(false), 5000);
        });

        document.getElementById('currentDeviceId').textContent = currentState.deviceId;
        initListeners();
    </script>
</body>
</html>